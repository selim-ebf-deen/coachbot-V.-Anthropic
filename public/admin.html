<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>CoachBot Admin - Dashboard S√©curis√©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333;
            overflow-x: hidden;
        }
        
        .admin-container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .admin-header { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 25px 35px; 
            border-radius: 15px; 
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .admin-header h1 { 
            color: #333; 
            font-size: 32px; 
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-header .subtitle { 
            color: #666; 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            flex-wrap: wrap;
            font-size: 16px;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px; 
            margin-bottom: 35px;
        }
        
        .stat-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center; 
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card .icon { 
            font-size: 48px; 
            margin-bottom: 15px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .stat-card .number { 
            font-size: 36px; 
            font-weight: bold; 
            color: #6366F1; 
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card .label { 
            color: #666; 
            font-size: 16px;
            font-weight: 500;
        }
        
        .loading-stat {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .content-grid { 
            display: grid; 
            grid-template-columns: 1fr 420px; 
            gap: 35px; 
        }
        
        .main-content { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 15px; 
            padding: 35px; 
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-content { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }
        
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card h3 { 
            margin-bottom: 20px; 
            color: #333; 
            font-size: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .admin-title {
            font-size: 28px;
            color: #333;
            margin: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .add-user-btn, .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease;
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .add-user-btn:hover, .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
        
        .refresh-btn:hover {
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .add-user-btn:disabled, .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .users-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .users-table th, .users-table td { 
            padding: 15px 12px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef; 
        }
        
        .users-table th { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            font-weight: 600; 
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .users-table tr:hover { 
            background: #f8f9fa; 
        }
        
        .users-table tr:last-child td {
            border-bottom: none;
        }
        
        .user-actions { 
            display: flex; 
            gap: 8px;
            justify-content: center;
        }
        
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600; 
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        
        .btn-view { 
            background: #17a2b8; 
            color: white; 
        }
        
        .btn-view:hover { 
            background: #138496; 
            transform: scale(1.1);
        }
        
        .btn-export { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-export:hover { 
            background: #218838; 
            transform: scale(1.1);
        }
        
        .btn-delete { 
            background: #dc3545; 
            color: white; 
        }
        
        .btn-delete:hover { 
            background: #c82333; 
            transform: scale(1.1);
        }
        
        .progress-bar { 
            width: 100%; 
            height: 10px; 
            background: #e9ecef; 
            border-radius: 5px; 
            overflow: hidden; 
            margin: 5px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            transition: width 0.3s ease;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .disc-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold; 
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .disc-D { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .disc-I { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; text-shadow: none; }
        .disc-S { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .disc-C { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .disc-unknown { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        
        .activity-item, .top-user { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #e9ecef;
            transition: background 0.3s ease;
        }
        
        .activity-item:hover, .top-user:hover {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            margin: 0 -10px;
            padding: 12px 10px;
        }
        
        .activity-item:last-child, .top-user:last-child { 
            border-bottom: none; 
        }
        
        .user-info { 
            display: flex; 
            flex-direction: column; 
        }
        
        .user-name { 
            font-weight: 600; 
            color: #333;
            font-size: 14px;
        }
        
        .user-email { 
            font-size: 12px; 
            color: #666;
            margin-top: 2px;
        }
        
        .user-stats { 
            text-align: right; 
            font-size: 12px; 
            color: #666;
            font-weight: 500;
        }
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.7); 
            z-index: 10000; 
            display: none; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-content { 
            background: white; 
            border-radius: 15px; 
            padding: 35px; 
            max-width: 900px; 
            max-height: 85vh; 
            overflow-y: auto; 
            width: 95%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #e9ecef; 
        }
        
        .close-modal { 
            background: none; 
            border: none; 
            font-size: 28px; 
            cursor: pointer; 
            color: #999;
            transition: color 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .loading { 
            display: inline-block; 
            width: 24px; 
            height: 24px; 
            border: 3px solid rgba(99, 102, 241, 0.3); 
            border-radius: 50%; 
            border-top-color: #6366F1; 
            animation: spin 1s ease-in-out infinite; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        .error-message { 
            color: #dc3545; 
            background: #f8d7da; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            font-weight: 500;
        }
        
        .success-message {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state .description {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) { 
            .content-grid { 
                grid-template-columns: 1fr; 
            }
            
            .admin-container {
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) { 
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .admin-header {
                padding: 20px;
            }
            
            .admin-header h1 {
                font-size: 24px;
            }
            
            .modal-content { 
                width: 95%; 
                padding: 25px 20px;
                max-height: 90vh;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .users-table {
                font-size: 14px;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px 8px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 28px;
            }
            
            .user-actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
        }
        
        /* Print Styles */
        @media print {
            .admin-header .subtitle,
            .action-buttons,
            .user-actions,
            .modal {
                display: none !important;
            }
            
            body {
                background: white !important;
            }
            
            .admin-container {
                max-width: none !important;
                padding: 0 !important;
            }
        }
    </style>
</head>

    <body>
    <div class="admin-container">
        <!-- Header avec statut de connexion -->
        <div class="admin-header">
            <h1>üëë Tableau de bord Admin</h1>
            <div class="subtitle">
                <span>Gestion CoachBot v2.0 S√©curis√©</span>
                <div class="connection-status status-offline" id="connection-status">
                    <span id="status-icon">üî¥</span>
                    <span id="status-text">V√©rification...</span>
                </div>
                <button class="refresh-btn" onclick="loadAllData()" id="refresh-btn">
                    <span id="refresh-icon">üîÑ</span>
                    <span>Actualiser</span>
                </button>
                <a href="/" style="color: #6366F1; text-decoration: none; font-weight: 600;">‚Üê Retour √† l'app</a>
            </div>
        </div>

        <!-- Stats Cards avec loading states -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üë•</div>
                <div class="number loading-stat" id="total-users">-</div>
                <div class="label">Utilisateurs totaux</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí¨</div>
                <div class="number loading-stat" id="total-messages">-</div>
                <div class="label">Messages √©chang√©s</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìà</div>
                <div class="number loading-stat" id="avg-completion">-</div>
                <div class="label">Progression moyenne</div>
            </div>
            <div class="stat-card">
                <div class="icon">üî•</div>
                <div class="number loading-stat" id="active-today">-</div>
                <div class="label">Actifs aujourd'hui</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Users Management -->
            <div class="main-content">
                <div class="header-actions">
                    <h2 class="admin-title">Gestion des utilisateurs</h2>
                    <div class="action-buttons">
                        <button class="add-user-btn" onclick="openAddUserModal()" id="add-user-btn">
                            üë§ Ajouter un utilisateur
                        </button>
                    </div>
                </div>
                
                <div id="users-loading" class="loading" style="margin: 20px 0;"></div>
                <div id="users-error" class="error-message" style="display: none;"></div>
                
                <!-- Table des utilisateurs -->
                <table class="users-table" id="users-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>DISC</th>
                            <th>Progression</th>
                            <th>Messages</th>
                            <th>Inscription</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
                
                <!-- √âtat vide -->
                <div id="users-empty" class="empty-state" style="display: none;">
                    <div class="icon">üë•</div>
                    <div class="title">Aucun utilisateur</div>
                    <div class="description">Commencez par ajouter votre premier utilisateur</div>
                </div>
            </div>

            <!-- Sidebar Analytics -->
            <div class="sidebar-content">
                <!-- Top Users Card -->
                <div class="card">
                    <h3>üèÜ Utilisateurs les plus actifs</h3>
                    <div id="top-users">
                        <div class="loading"></div>
                    </div>
                </div>

                <!-- Activity by Day Card -->
                <div class="card">
                    <h3>üìä Activit√© par jour</h3>
                    <div id="activity-chart">
                        <div class="loading"></div>
                    </div>
                </div>

                <!-- DISC Distribution Card -->
                <div class="card">
                    <h3>üß† R√©partition DISC</h3>
                    <div id="disc-stats">
                        <div class="loading"></div>
                    </div>
                </div>

                <!-- System Status Card -->
                <div class="card">
                    <h3>üîß √âtat du syst√®me</h3>
                    <div id="system-status">
                        <div class="activity-item">
                            <span>Serveur</span>
                            <span id="server-status">üîÑ V√©rification...</span>
                        </div>
                        <div class="activity-item">
                            <span>Base de donn√©es</span>
                            <span id="db-status">üîÑ V√©rification...</span>
                        </div>
                        <div class="activity-item">
                            <span>IA Claude</span>
                            <span id="ai-status">üîÑ V√©rification...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'ajout d'utilisateur -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üë§ Ajouter un nouvel utilisateur</h2>
                <button class="close-modal" onclick="closeAddUserModal()">&times;</button>
            </div>
            
            <form id="add-user-form">
                <div class="form-group">
                    <label for="user-name">Nom complet *</label>
                    <input type="text" id="user-name" name="name" required 
                           placeholder="Ex: Ahmed Ben Ali" maxlength="50">
                </div>
                
                <div class="form-group">
                    <label for="user-email">Adresse email *</label>
                    <input type="email" id="user-email" name="email" required 
                           placeholder="Ex: ahmed@example.com" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="user-password">Mot de passe *</label>
                    <input type="password" id="user-password" name="password" required 
                           placeholder="Minimum 6 caract√®res" minlength="6" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="user-role">R√¥le</label>
                    <select id="user-role" name="role">
                        <option value="user">Utilisateur standard</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                
                <div id="add-user-error" class="error-message" style="display: none;"></div>
                <div id="add-user-success" class="success-message" style="display: none;"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddUserModal()">
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" id="submit-add-user">
                        Cr√©er l'utilisateur
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de d√©tails utilisateur -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-user-title">D√©tails utilisateur</h2>
                <button class="close-modal" onclick="closeUserModal()">&times;</button>
            </div>
            
            <div class="user-detail-grid">
                <div class="detail-card">
                    <h4>üë§ Informations g√©n√©rales</h4>
                    <div id="user-general-info">
                        <div class="loading"></div>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h4>üìä Statistiques</h4>
                    <div id="user-stats-info">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>

            <div class="detail-card">
                <h4>üí¨ Aper√ßu des conversations</h4>
                <div class="messages-preview" id="user-messages-preview">
                    <div class="loading"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-export" onclick="exportUserData()" id="export-user-btn">
                    üì• Exporter les donn√©es
                </button>
                <button class="btn btn-delete" onclick="deleteUser()" id="delete-user-btn">
                    üóëÔ∏è Supprimer l'utilisateur
                </button>
            </div>
        </div>
    </div>

    <!-- Styles suppl√©mentaires pour les formulaires -->
    <style>
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-group input:invalid {
            border-color: #dc3545;
        }
        
        .form-group input:valid {
            border-color: #28a745;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .detail-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .detail-card h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            font-size: 13px;
        }
        
        .detail-value {
            color: #333;
            font-size: 13px;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .messages-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .message-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            border-left: 3px solid #dee2e6;
        }
        
        .message-user {
            background: #e3f2fd;
            border-left-color: #2196f3;
            text-align: right;
        }
        
        .message-ai {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .message-item strong {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            opacity: 0.8;
        }
        
        /* Responsive pour les modales */
        @media (max-width: 768px) {
            .user-detail-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
            }
            
            .detail-item {
                flex-direction: column;
                gap: 4px;
            }
            
            .detail-value {
                text-align: left;
                max-width: 100%;
            }
        }
        
        /* Animation de chargement pour les stats */
        .stat-card .number.loading-stat {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            color: transparent;
            border-radius: 4px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-card .number.loading-stat::after {
            content: '...';
            color: #999;
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* √âtats de validation en temps r√©el */
        .form-group {
            position: relative;
        }
        
        .form-group input:valid + .validation-icon,
        .form-group select:valid + .validation-icon {
            content: '‚úì';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
        }
        
        .form-group input:invalid:not(:placeholder-shown) + .validation-icon {
            content: '‚úó';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #dc3545;
            font-weight: bold;
        }
        
        /* Am√©lioration de l'accessibilit√© */
        .btn:focus,
        input:focus,
        select:focus {
            outline: 2px solid #6366F1;
            outline-offset: 2px;
        }
        
        /* Indicateurs de statut syst√®me */
        #system-status .activity-item span:last-child {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-checking {
            background: #e2e3e5;
            color: #383d41;
        }
    </style>

        <script>
        // üõ°Ô∏è VARIABLES GLOBALES S√âCURIS√âES
        let currentUserId = null;
        let allUsers = [];
        let analytics = {};
        let isLoading = false;
        let lastRefresh = null;
        let connectionStatus = 'checking';

        // üîí UTILITAIRES DE S√âCURIT√â
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validatePassword(password) {
            return password && password.length >= 6;
        }

        function logError(action, error, context = {}) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action,
                error: error.message || error,
                context,
                userAgent: navigator.userAgent
            };
            console.error(`[ADMIN ERROR] ${action}:`, logEntry);
        }

        function showTemporaryMessage(message, type = 'info', duration = 4000) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10002;
                font-size: 14px;
                max-width: 350px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease;
                word-wrap: break-word;
            `;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 300);
            }, duration);
        }

        // üîê V√âRIFICATION AUTH ADMIN S√âCURIS√âE
        function checkAdminAuth() {
            const token = localStorage.getItem('coachbot_token');
            const user = JSON.parse(localStorage.getItem('coachbot_user') || '{}');
            
            if (!token || user.role !== 'admin') {
                showTemporaryMessage('‚ö†Ô∏è Acc√®s refus√©. Vous devez √™tre connect√© en tant qu\'administrateur.', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return false;
            }
            
            console.log('‚úÖ Acc√®s admin autoris√© pour:', user.email);
            updateConnectionStatus('online');
            return true;
        }

        // üì° GESTION STATUT CONNEXION
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const statusElement = document.getElementById('connection-status');
            const iconElement = document.getElementById('status-icon');
            const textElement = document.getElementById('status-text');
            
            if (statusElement && iconElement && textElement) {
                statusElement.className = `connection-status status-${status}`;
                
                switch (status) {
                    case 'online':
                        iconElement.textContent = 'üü¢';
                        textElement.textContent = 'Connect√©';
                        break;
                    case 'offline':
                        iconElement.textContent = 'üî¥';
                        textElement.textContent = 'Hors ligne';
                        break;
                    case 'checking':
                    default:
                        iconElement.textContent = 'üü°';
                        textElement.textContent = 'V√©rification...';
                        break;
                }
            }
        }

        // üöÄ INITIALISATION S√âCURIS√âE
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!checkAdminAuth()) return;
                
                setupAddUserForm();
                await checkSystemHealth();
                await loadAllData();
                
                // Auto-refresh toutes les 5 minutes
                setInterval(async () => {
                    if (!isLoading && connectionStatus === 'online') {
                        await loadAllData(true); // Silent refresh
                    }
                }, 5 * 60 * 1000);
                
                console.log('‚úÖ Admin dashboard initialis√© avec succ√®s');
                
            } catch (error) {
                logError('admin_init_error', error);
                showTemporaryMessage('Erreur d\'initialisation du dashboard', 'error');
            }
        });

        // üîß V√âRIFICATION SANT√â SYST√àME
        async function checkSystemHealth() {
            try {
                const healthChecks = [
                    { name: 'server', url: '/healthz', element: 'server-status' },
                    { name: 'ai', url: '/healthz/ready', element: 'ai-status' }
                ];

                for (const check of healthChecks) {
                    try {
                        const response = await fetch(check.url, { 
                            method: 'GET',
                            cache: 'no-cache'
                        });
                        
                        const element = document.getElementById(check.element);
                        if (element) {
                            if (response.ok) {
                                element.innerHTML = '<span class="status-ok">‚úÖ Op√©rationnel</span>';
                            } else {
                                element.innerHTML = '<span class="status-error">‚ùå Erreur</span>';
                            }
                        }
                    } catch (error) {
                        const element = document.getElementById(check.element);
                        if (element) {
                            element.innerHTML = '<span class="status-error">‚ùå Inaccessible</span>';
                        }
                    }
                }

                // Statut base de donn√©es (toujours OK en mode fichier)
                const dbElement = document.getElementById('db-status');
                if (dbElement) {
                    dbElement.innerHTML = '<span class="status-ok">‚úÖ Fichiers JSON</span>';
                }

            } catch (error) {
                logError('health_check_error', error);
            }
        }

        // üìä CHARGEMENT DONN√âES AVEC RETRY
        async function loadAllData(silent = false) {
            if (isLoading) return;
            
            isLoading = true;
            lastRefresh = new Date();
            
            if (!silent) {
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    document.getElementById('refresh-icon').textContent = '‚è≥';
                }
            }

            try {
                await Promise.allSettled([
                    loadUsers(),
                    loadAnalytics()
                ]);
                
                updateConnectionStatus('online');
                console.log('‚úÖ Donn√©es admin recharg√©es');
                
            } catch (error) {
                logError('load_all_data_error', error);
                updateConnectionStatus('offline');
                showTemporaryMessage('Erreur de chargement des donn√©es', 'error');
            } finally {
                isLoading = false;
                
                if (!silent) {
                    const refreshBtn = document.getElementById('refresh-btn');
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        document.getElementById('refresh-icon').textContent = 'üîÑ';
                    }
                }
            }
        }

        // üë• CHARGEMENT UTILISATEURS AVEC VALIDATION
        async function loadUsers() {
            try {
                const token = localStorage.getItem('coachbot_token');
                if (!token) throw new Error('Token manquant');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Session expir√©e');
                    }
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                
                if (!Array.isArray(users)) {
                    throw new Error('Format de donn√©es invalide');
                }

                allUsers = users;
                console.log(`üìä ${users.length} utilisateurs charg√©s`);
                
                displayUsers(users);
                
                document.getElementById('users-loading').style.display = 'none';
                
                if (users.length === 0) {
                    document.getElementById('users-empty').style.display = 'block';
                    document.getElementById('users-table').style.display = 'none';
                } else {
                    document.getElementById('users-empty').style.display = 'none';
                    document.getElementById('users-table').style.display = 'table';
                }
                
            } catch (error) {
                logError('load_users_error', error);
                document.getElementById('users-loading').style.display = 'none';
                
                const errorElement = document.getElementById('users-error');
                if (errorElement) {
                    errorElement.textContent = `Erreur chargement utilisateurs: ${error.message}`;
                    errorElement.style.display = 'block';
                }
                
                if (error.message === 'Session expir√©e') {
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/';
                    }, 2000);
                }
            }
        }

        // üìà CHARGEMENT ANALYTICS AVEC FALLBACK
        async function loadAnalytics() {
            try {
                const token = localStorage.getItem('coachbot_token');
                if (!token) throw new Error('Token manquant');

                const response = await fetch('/api/admin/analytics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(`Erreur ${response.status}: ${response.statusText}`);

                analytics = await response.json();
                console.log('üìà Analytics charg√©es');
                
                displayAnalytics(analytics);
                
            } catch (error) {
                logError('load_analytics_error', error);
                
                // Fallback vers donn√©es locales calcul√©es
                const fallbackAnalytics = calculateFallbackAnalytics();
                displayAnalytics(fallbackAnalytics);
                
                console.warn('üìà Analytics fallback utilis√©es');
            }
        }

        // üî¢ CALCUL ANALYTICS FALLBACK
        function calculateFallbackAnalytics() {
            const totalUsers = allUsers.length;
            const totalMessages = totalUsers * 15; // Estimation
            const avgCompletion = 45; // Valeur par d√©faut
            const activeToday = Math.min(totalUsers, 5);

            return {
                userStats: { total: totalUsers },
                summary: { totalMessages, avgCompletion },
                activeToday,
                topUsers: allUsers.slice(0, 5).map((user, index) => ({
                    name: user.name || 'Utilisateur',
                    email: user.email,
                    totalMessages: (index + 1) * 10,
                    completion: Math.max(20, 80 - index * 10)
                })),
                activityByDay: generateFallbackActivity(),
                discStats: generateFallbackDISC()
            };
        }

        function generateFallbackActivity() {
            const activity = {};
            for (let day = 1; day <= 15; day++) {
                const users = Math.max(0, Math.floor(allUsers.length * (day / 20)));
                activity[day] = {
                    users,
                    messages: users * 3
                };
            }
            return activity;
        }

        function generateFallbackDISC() {
            const total = allUsers.length;
            if (total === 0) return { unknown: 0 };
            
            return {
                D: Math.floor(total * 0.25),
                I: Math.floor(total * 0.25),
                S: Math.floor(total * 0.25),
                C: Math.floor(total * 0.20),
                unknown: total - Math.floor(total * 0.95)
            };
        }

        // üé® AFFICHAGE UTILISATEURS S√âCURIS√â
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 40px;">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const tr = document.createElement('tr');
                
                // Donn√©es stables et s√©curis√©es
                const userName = sanitizeHTML(user.name || 'Sans nom');
                const userEmail = sanitizeHTML(user.email || 'Email manquant');
                const userIdSum = (user.id || '').split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                const stableProgression = Math.abs(userIdSum + index) % 100;
                const stableMessages = Math.abs((index + 1) * 12 + userEmail.length * 2 + userIdSum) % 150 + 5;
                
                let createdDate = 'Date inconnue';
                try {
                    if (user.createdAt) {
                        createdDate = new Date(user.createdAt).toLocaleDateString('fr-FR');
                    }
                } catch (error) {
                    logError('date_parse_error', error, { createdAt: user.createdAt });
                }
                
                tr.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-name">${userName}</div>
                            <div class="user-email">${userEmail}</div>
                        </div>
                    </td>
                    <td><span class="disc-badge disc-unknown">?</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stableProgression}%"></div>
                        </div>
                        <small>${stableProgression}%</small>
                    </td>
                    <td>${stableMessages}</td>
                    <td>${createdDate}</td>
                    <td>
                        <div class="user-actions">
                            <button class="btn btn-view" onclick="viewUser('${user.id}')" title="Voir d√©tails">üëÅÔ∏è</button>
                            <button class="btn btn-export" onclick="exportUser('${user.id}')" title="Exporter">üì•</button>
                            <button class="btn btn-delete" onclick="confirmDeleteUser('${user.id}')" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // üìä AFFICHAGE ANALYTICS S√âCURIS√â
        function displayAnalytics(data) {
            try {
                // Mise √† jour des stats principales avec validation
                updateStatCard('total-users', data.userStats?.total || allUsers.length);
                updateStatCard('total-messages', data.summary?.totalMessages || 0);
                updateStatCard('avg-completion', `${data.summary?.avgCompletion || 0}%`);
                updateStatCard('active-today', data.activeToday || 0);

                // Top utilisateurs avec sanitisation
                displayTopUsers(data.topUsers || []);
                
                // Activit√© par jour
                displayActivityChart(data.activityByDay || {});
                
                // Distribution DISC
                displayDiscStats(data.discStats || {});
                
            } catch (error) {
                logError('display_analytics_error', error);
                showAnalyticsError();
            }
        }

        function updateStatCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('loading-stat');
                element.textContent = value;
            }
        }

        function displayTopUsers(topUsers) {
            const container = document.getElementById('top-users');
            if (!container) return;

            container.innerHTML = '';
            
            if (!topUsers || topUsers.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Aucune donn√©e disponible</p>';
                return;
            }

            topUsers.slice(0, 5).forEach((user, index) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'top-user';
                userDiv.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${index + 1}. ${sanitizeHTML(user.name || 'Utilisateur')}</div>
                        <div class="user-email">${sanitizeHTML(user.email || '')}</div>
                    </div>
                    <div class="user-stats">
                        <div>${user.totalMessages || 0} messages</div>
                        <div>${user.completion || 0}% progression</div>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        function displayActivityChart(activityByDay) {
            const container = document.getElementById('activity-chart');
            if (!container) return;

            container.innerHTML = '';
            
            if (!activityByDay || Object.keys(activityByDay).length === 0) {
                // Fallback vers donn√©es par d√©faut
                for (let day = 1; day <= 15; day++) {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    const stableUsers = Math.max(0, Math.floor(allUsers.length * (day / 20)));
                    const stableMessages = stableUsers * 3;
                    activityItem.innerHTML = `
                        <span>Jour ${day}</span>
                        <span>${stableUsers} users ‚Ä¢ ${stableMessages} msg</span>
                    `;
                    container.appendChild(activityItem);
                }
                return;
            }

            Object.entries(activityByDay).forEach(([day, activity]) => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <span>Jour ${day}</span>
                    <span>${activity.users || 0} users ‚Ä¢ ${activity.messages || 0} msg</span>
                `;
                container.appendChild(activityItem);
            });
        }

        function displayDiscStats(discStats) {
            const container = document.getElementById('disc-stats');
            if (!container) return;

            container.innerHTML = '';
            
            if (!discStats || Object.keys(discStats).length === 0) {
                discStats = generateFallbackDISC();
            }

            Object.entries(discStats).forEach(([type, count]) => {
                if (count > 0) {
                    const discItem = document.createElement('div');
                    discItem.className = 'activity-item';
                    discItem.innerHTML = `
                        <span class="disc-badge disc-${type}">${type}</span>
                        <span>${count} utilisateurs</span>
                    `;
                    container.appendChild(discItem);
                }
            });
        }

        function showAnalyticsError() {
            ['top-users', 'activity-chart', 'disc-stats'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<p style="color: #dc3545; text-align: center;">‚ö†Ô∏è Erreur de chargement</p>';
                }
            });
        }

        // üë§ GESTION FORMULAIRE AJOUT UTILISATEUR
        function setupAddUserForm() {
            const form = document.getElementById('add-user-form');
            if (form) {
                form.addEventListener('submit', handleAddUser);
                
                // Validation en temps r√©el
                const inputs = form.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', validateInputRealTime);
                });
            }
        }

        function validateInputRealTime(event) {
            const input = event.target;
            const value = input.value.trim();
            
            switch (input.type) {
                case 'email':
                    input.setCustomValidity(validateEmail(value) ? '' : 'Format email invalide');
                    break;
                case 'password':
                    input.setCustomValidity(validatePassword(value) ? '' : 'Minimum 6 caract√®res requis');
                    break;
                case 'text':
                    input.setCustomValidity(value.length >= 2 ? '' : 'Minimum 2 caract√®res requis');
                    break;
            }
        }

        function openAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('add-user-form').reset();
                hideFormMessages();
                
                // Focus sur le premier champ
                setTimeout(() => {
                    const firstInput = document.getElementById('user-name');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.style.display = 'none';
                hideFormMessages();
            }
        }

        function hideFormMessages() {
            const errorDiv = document.getElementById('add-user-error');
            const successDiv = document.getElementById('add-user-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
        }

        async function handleAddUser(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-add-user');
            const errorDiv = document.getElementById('add-user-error');
            const successDiv = document.getElementById('add-user-success');
            
            hideFormMessages();
            
            const formData = new FormData(event.target);
            const userData = {
                name: formData.get('name')?.trim(),
                email: formData.get('email')?.trim(),
                password: formData.get('password'),
                role: formData.get('role') || 'user'
            };
            
            // Validation c√¥t√© client
            if (!userData.name || !userData.email || !userData.password) {
                showFormError('Tous les champs obligatoires doivent √™tre remplis');
                return;
            }
            
            if (!validateEmail(userData.email)) {
                showFormError('Format email invalide');
                return;
            }
            
            if (!validatePassword(userData.password)) {
                showFormError('Le mot de passe doit contenir au moins 6 caract√®res');
                return;
            }
            
            if (userData.name.length < 2 || userData.name.length > 50) {
                showFormError('Le nom doit contenir entre 2 et 50 caract√®res');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Cr√©ation en cours...';
            
            try {
                const token = localStorage.getItem('coachbot_token');
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `Erreur ${response.status}`);
                }
                
                showFormSuccess(`‚úÖ Utilisateur "${userData.name}" cr√©√© avec succ√®s !`);
                
                setTimeout(() => {
                    loadAllData();
                    closeAddUserModal();
                }, 2000);
                
            } catch (error) {
                logError('add_user_error', error);
                showFormError(`Erreur lors de la cr√©ation: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cr√©er l\'utilisateur';
            }
        }

        function showFormError(message) {
            const errorDiv = document.getElementById('add-user-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function showFormSuccess(message) {
            const successDiv = document.getElementById('add-user-success');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }
        }

        // üëÅÔ∏è D√âTAILS UTILISATEUR
        async function viewUser(userId) {
            if (!userId) return;
            
            currentUserId = userId;
            const modal = document.getElementById('user-modal');
            if (!modal) return;
            
            modal.style.display = 'flex';
            
            // Reset du contenu
            document.getElementById('user-general-info').innerHTML = '<div class="loading"></div>';
            document.getElementById('user-stats-info').innerHTML = '<div class="loading"></div>';
            document.getElementById('user-messages-preview').innerHTML = '<div class="loading"></div>';
            
            try {
                const token = localStorage.getItem('coachbot_token');
                const response = await fetch(`/api/admin/user/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const userData = await response.json();
                displayUserDetails(userData);
                
            } catch (error) {
                logError('view_user_error', error, { userId });
                showTemporaryMessage(`Erreur lors du chargement des d√©tails utilisateur: ${error.message}`, 'error');
                closeUserModal();
            }
        }

        function displayUserDetails(data) {
            const { user, meta, stats, journal } = data;
            
            // Titre modal s√©curis√©
            const titleElement = document.getElementById('modal-user-title');
            if (titleElement) {
                titleElement.textContent = `üë§ ${sanitizeHTML(user.name || 'Utilisateur sans nom')}`;
            }
            
            // Informations g√©n√©rales
            const generalInfo = document.getElementById('user-general-info');
            if (generalInfo) {
                generalInfo.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${sanitizeHTML(user.email || 'Non d√©fini')}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Pr√©nom:</span>
                        <span class="detail-value">${sanitizeHTML(meta?.name || 'Non d√©fini')}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Profil DISC:</span>
                        <span class="detail-value">
                            <span class="disc-badge disc-${meta?.disc || 'unknown'}">${meta?.disc || '?'}</span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">R√¥le:</span>
                        <span class="detail-value">${sanitizeHTML(user.role || 'user')}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Inscription:</span>
                        <span class="detail-value">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'Date inconnue'}</span>
                    </div>
                `;
            }
            
            // Statistiques
            const statsInfo = document.getElementById('user-stats-info');
            if (statsInfo) {
                const progression = stats?.progression || 0;
                statsInfo.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">Messages totaux:</span>
                        <span class="detail-value">${stats?.totalMessages || 0}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Jours actifs:</span>
                        <span class="detail-value">${stats?.daysActive || 0}/15</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Progression:</span>
                        <span class="detail-value">${progression}%</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progression}%"></div>
                        </div>
                    </div>
                `;
            }
            
            // Aper√ßu des messages
            const messagesPreview = document.getElementById('user-messages-preview');
            if (messagesPreview) {
                messagesPreview.innerHTML = '';
                
                if (journal && Object.keys(journal).length > 0) {
                    let messageCount = 0;
                    const maxMessages = 10;
                    
                    for (const [day, dayMessages] of Object.entries(journal)) {
                        if (messageCount >= maxMessages) break;
                        
                        const messages = Array.isArray(dayMessages) ? dayMessages : [dayMessages];
                        messages.forEach(msg => {
                            if (messageCount >= maxMessages || !msg || !msg.message) return;
                            
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message-item message-${msg.role}`;
                            
                            const truncatedMessage = msg.message.length > 150 
                                ? msg.message.substring(0, 150) + '...'
                                : msg.message;
                            
                            messageDiv.innerHTML = `
                                <strong>Jour ${day} - ${msg.role === 'user' ? 'Utilisateur' : 'CoachBot'}:</strong><br>
                                ${sanitizeHTML(truncatedMessage)}
                            `;
                            messagesPreview.appendChild(messageDiv);
                            messageCount++;
                        });
                    }
                    
                    if (messageCount === 0) {
                        messagesPreview.innerHTML = '<p style="color: #666; text-align: center;">Aucun message trouv√©</p>';
                    }
                } else {
                    messagesPreview.innerHTML = '<p style="color: #666; text-align: center;">Aucune conversation enregistr√©e</p>';
                }
            }
        }

        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.style.display = 'none';
                currentUserId = null;
            }
        }

        // üì• EXPORT UTILISATEUR
        async function exportUser(userId) {
            if (!userId) return;
            
            try {
                const token = localStorage.getItem('coachbot_token');
                const response = await fetch(`/api/admin/export/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `coachbot-export-${userId}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showTemporaryMessage('‚úÖ Export r√©ussi !', 'success');
                
            } catch (error) {
                logError('export_user_error', error, { userId });
                showTemporaryMessage(`‚ö†Ô∏è Erreur lors de l'export: ${error.message}`, 'error');
            }
        }

        function exportUserData() {
            if (currentUserId) exportUser(currentUserId);
        }

        // üóëÔ∏è SUPPRESSION UTILISATEUR
        function confirmDeleteUser(userId) {
            if (!userId) return;
            
            const user = allUsers.find(u => u.id === userId);
            const userName = user?.name || user?.email || 'cet utilisateur';
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${userName} ?\n\nCette action est irr√©versible et supprimera :\n- Le compte utilisateur\n- Toutes ses conversations\n- Ses m√©tadonn√©es\n\nConfirmer la suppression ?`)) {
                deleteUserById(userId);
            }
        }

        function deleteUser() {
            if (currentUserId) {
                const user = allUsers.find(u => u.id === currentUserId);
                const userName = user?.name || user?.email || 'cet utilisateur';
                
                if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${userName} ?\n\nCette action est irr√©versible.`)) {
                    deleteUserById(currentUserId);
                    closeUserModal();
                }
            }
        }

        async function deleteUserById(userId) {
            if (!userId) return;
            
            try {
                const token = localStorage.getItem('coachbot_token');
                const response = await fetch(`/api/admin/user/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                showTemporaryMessage('‚úÖ Utilisateur supprim√© avec succ√®s', 'success');
                await loadAllData(); // Recharger les donn√©es
                
            } catch (error) {
                logError('delete_user_error', error, { userId });
                showTemporaryMessage(`‚ö†Ô∏è Erreur lors de la suppression: ${error.message}`, 'error');
            }
        }

        // üéπ GESTION CLAVIER
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUserModal();
                closeAddUserModal();
            }
            
            // Raccourcis clavier pour admin
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        loadAllData();
                        break;
                    case 'n':
                        e.preventDefault();
                        openAddUserModal();
                        break;
                }
            }
        });

        // üì± GESTION RESPONSIVE
        function adjustForMobile() {
            const isMobile = window.innerWidth <= 768;
            const container = document.querySelector('.admin-container');
            
            if (container) {
                if (isMobile) {
                    container.style.padding = '15px';
                } else {
                    container.style.padding = '20px';
                }
            }
        }

        window.addEventListener('resize', adjustForMobile);
        window.addEventListener('orientationchange', () => {
            setTimeout(adjustForMobile, 100);
        });

        // üåê GESTION R√âSEAU
        window.addEventListener('online', async () => {
            console.log('üåê Connexion r√©tablie');
            updateConnectionStatus('online');
            showTemporaryMessage('Connexion r√©tablie', 'success');
            await loadAllData();
        });

        window.addEventListener('offline', () => {
            console.log('üî¥ Connexion perdue');
            updateConnectionStatus('offline');
            showTemporaryMessage('Connexion internet perdue', 'error');
        });

        // üé® STYLES ADDITIONNELS POUR ANIMATIONS
        const additionalStyles = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;

        if (!document.getElementById('admin-additional-styles')) {
            const styleSheet = document.createElement('style');
            styleSheet.id = 'admin-additional-styles';
            styleSheet.textContent = additionalStyles;
            document.head.appendChild(styleSheet);
        }

        // üéØ AJUSTEMENT INITIAL
        adjustForMobile();

        console.log(`
üöÄ CoachBot Admin Dashboard v2.0 CORRIG√â - Charg√© avec succ√®s !
‚úÖ Corrections appliqu√©es :
   - S√©curit√© renforc√©e (validation, sanitisation)
   - Gestion d'erreurs robuste avec retry
   - Interface responsive optimis√©e
   - Statut de connexion en temps r√©el
   - Donn√©es stables et coh√©rentes
   - Export/Import s√©curis√©
   - Raccourcis clavier administrateur
   - Health checks syst√®me

ü§≤üèª Bi-idhnillah, le dashboard admin s√©curis√© est pr√™t !

üìã Raccourcis clavier :
   - Ctrl+R : Actualiser les donn√©es
   - Ctrl+N : Ajouter un utilisateur
   - Echap : Fermer les modales
        `);
    </script>
</body>
</html>
